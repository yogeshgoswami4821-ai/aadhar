let allData = [];
let charts = {};

function initDashboard() {
    createCharts();
}

function createCharts() {
    const ids = ['enrolmentChart', 'comparisonChart'];
    ids.forEach(id => {
        let canvas = document.getElementById(id);
        if (canvas) {
            let fresh = canvas.cloneNode(true);
            canvas.parentNode.replaceChild(fresh, canvas);
        }
    });
    const ctx1 = document.getElementById('enrolmentChart')?.getContext('2d');
    if (ctx1) {
        charts.main = new Chart(ctx1, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Total Enrolments', data: [], backgroundColor: '#ef4444' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
}

function getCleanState(name) {
    if (!name) return null;
    let s = name.toString().toUpperCase().trim();
    
    // Yahan Dadra & Nagar Haveli aur Daman Diu ko block kar diya hai
    const block = ["DADRA", "DAMAN", "NAGAR", "HAVELI", "DIU", "DARBHANGA", "100000", "TOTAL"];
    if (block.some(b => s.includes(b))) return null;
    
    // West Bengal aur Chhattisgarh merging
    if (s.includes("BENG")) return "West Bengal";
    if (s.includes("CHHATTIS")) return "Chhattisgarh";
    
    return s.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
}

async function uploadCSV() {
    const files = document.getElementById("fileInput").files;
    if (!files.length) return;
    
    allData = [];
    for (let f of files) {
        const text = await f.text();
        const lines = text.split('\n').filter(l => l.trim() !== "");
        
        lines.forEach(line => {
            const row = line.split(',');
            if (row.length < 3) return;

            // Enrolment number dhundna
            let nums = row.map(v => parseInt(v.toString().replace(/[^0-9]/g, '')) || 0);
            let val = Math.max(...nums);
            
            // State aur District text dhundna
            let texts = row.filter(v => v && isNaN(v) && v.length > 2 && !v.includes('/') && !v.includes('-'));
            let state = getCleanState(texts[0]);

            if (state && val > 0) {
                allData.push({ 
                    state: state, 
                    dist: (texts[1] || texts[0]).trim().toLowerCase().replace(/\b\w/g, l => l.toUpperCase()), 
                    val: val 
                });
            }
        });
    }
    renderUI();
}

function renderUI() {
    // Top 15 data points
    let sorted = allData.sort((a, b) => b.val - a.val).slice(0, 15);
    
    // 1. Cards update
    const container = document.getElementById("resultContainer");
    if (container) {
        container.innerHTML = sorted.map(d => `
            <div class="status-card" style="border-left:5px solid #ef4444; background:#fff; padding:12px; margin-bottom:8px; border-radius:8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="font-weight:bold; color:#1f2937;">${d.dist}</div>
                <div style="font-size:11px; color:#6b7280;">${d.state}</div>
                <div style="font-size:18px; color:#2563eb; font-weight:bold; margin-top:5px;">${d.val.toLocaleString()}</div>
            </div>`).join('');
    }

    // 2. Charts update
    if (charts.main) {
        charts.main.data.labels = sorted.slice(0, 10).map(d => d.dist);
        charts.main.data.datasets[0].data = sorted.slice(0, 10).map(d => d.val);
        charts.main.update();
    }

    // 3. Stats update
    const stats = document.getElementById("totalCountDisplay");
    if (stats) stats.innerText = "Total Regions: " + allData.length;
}

window.onload = initDashboard;
